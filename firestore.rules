rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // Helper Functions
    // ========================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is the resource owner
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is admin (based on user document userType)
    function isAdmin() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'admin';
    }

    // Get user document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is verified
    function isVerifiedUser() {
      return isAuthenticated() &&
             getUserData().isVerified == true;
    }

    // Check if the user is a participant in a conversation
    function isConversationParticipant(conversationData) {
      return request.auth.uid in conversationData.participants.userId;
    }

    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // Check if data is being created (not updated)
    function isCreating() {
      return !exists(/databases/$(database)/documents/$(request.path));
    }

    // ========================================
    // Users Collection
    // ========================================
    match /users/{userId} {
      // Anyone authenticated can read basic user profiles (for browsing)
      allow read: if isAuthenticated();

      // Users can only create their own profile during registration
      allow create: if isOwner(userId) &&
                      hasRequiredFields(['email', 'firstName', 'lastName', 'userType']) &&
                      request.resource.data.id == userId;

      // Users can only update their own profile
      // Exception: rating and reviewCount can be updated by review system
      allow update: if isAuthenticated() && (
                      // Owner updating their own profile
                      (isOwner(userId) &&
                       // Cannot change immutable fields
                       request.resource.data.id == resource.data.id &&
                       request.resource.data.email == resource.data.email &&
                       request.resource.data.userType == resource.data.userType &&
                       request.resource.data.createdAt == resource.data.createdAt) ||
                      // OR anyone can update ONLY rating and reviewCount (review system)
                      (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rating', 'reviewCount', 'updatedAt'])) ||
                      // OR admin can update userType
                      isAdmin()
                    );

      // Users can delete their own profile
      allow delete: if isOwner(userId) || isAdmin();

      // Subcollection: User verification documents (private)
      match /verificationDocuments/{docId} {
        allow read, write: if isOwner(userId) || isAdmin();
      }

      // Subcollection: Emergency contacts (private)
      match /emergencyContacts/{contactId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ========================================
    // Gigs Collection
    // ========================================
    match /gigs/{gigId} {
      // Anyone can read open gigs (public browsing), authenticated users can read all
      allow read: if true; // Public read access for gig browsing

      // Only authenticated users can create gigs
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['title', 'description', 'category', 'budget', 'employerId']) &&
                      request.resource.data.employerId == request.auth.uid &&
                      request.resource.data.status == 'open' &&
                      // Budget validation: must be integer between R100 and R1,000,000
                      request.resource.data.budget is int &&
                      request.resource.data.budget >= 100 &&
                      request.resource.data.budget <= 1000000;

      // Only the employer (owner) can update their gig
      allow update: if isAuthenticated() &&
                      resource.data.employerId == request.auth.uid &&
                      // Cannot change employer
                      request.resource.data.employerId == resource.data.employerId &&
                      request.resource.data.createdAt == resource.data.createdAt &&
                      // If budget is updated, validate it
                      (request.resource.data.budget == resource.data.budget ||
                       (request.resource.data.budget is int &&
                        request.resource.data.budget >= 100 &&
                        request.resource.data.budget <= 1000000));

      // Only the employer or admin can delete the gig
      allow delete: if isAuthenticated() &&
                      (resource.data.employerId == request.auth.uid || isAdmin());
    }

    // ========================================
    // Applications Collection
    // ========================================
    match /applications/{applicationId} {
      // Anyone can read applications for counting and public display
      // This allows showing application counts on gig cards
      // Note: Sensitive details should be handled at the application layer
      allow read: if true;

      // Only authenticated job seekers can create applications
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['gigId', 'applicantId', 'proposedRate']) &&
                      request.resource.data.applicantId == request.auth.uid &&
                      request.resource.data.status == 'pending' &&
                      // Verify the gig exists
                      exists(/databases/$(database)/documents/gigs/$(request.resource.data.gigId));

      // Applicant can update their own application (before accepted)
      // Employer can update application status
      allow update: if isAuthenticated() &&
                      (
                        // Applicant updating their own pending application (including withdrawal)
                        (request.auth.uid == resource.data.applicantId &&
                         resource.data.status == 'pending' &&
                         (request.resource.data.status == 'pending' || request.resource.data.status == 'withdrawn')) ||
                        // Employer updating application status (check gig ownership)
                        (exists(/databases/$(database)/documents/gigs/$(resource.data.gigId)) &&
                         request.auth.uid == get(/databases/$(database)/documents/gigs/$(resource.data.gigId)).data.employerId &&
                         request.resource.data.applicantId == resource.data.applicantId &&
                         request.resource.data.gigId == resource.data.gigId)
                      );

      // Only applicant or admin can delete
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == resource.data.applicantId || isAdmin());
    }

    // ========================================
    // Reviews Collection
    // ========================================
    match /reviews/{reviewId} {
      // Anyone authenticated can read reviews
      allow read: if isAuthenticated();

      // Users can create reviews for completed gigs they participated in
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['gigId', 'reviewerId', 'revieweeId', 'rating', 'type']) &&
                      request.resource.data.reviewerId == request.auth.uid &&
                      request.resource.data.rating >= 1 &&
                      request.resource.data.rating <= 5 &&
                      // Verify gig exists and user was involved
                      exists(/databases/$(database)/documents/gigs/$(request.resource.data.gigId));

      // Reviewers can update their own reviews within 24 hours
      allow update: if isAuthenticated() &&
                      request.auth.uid == resource.data.reviewerId &&
                      request.time < resource.data.createdAt + duration.value(24, 'h') &&
                      request.resource.data.reviewerId == resource.data.reviewerId &&
                      request.resource.data.gigId == resource.data.gigId;

      // Only reviewer or admin can delete
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == resource.data.reviewerId || isAdmin());
    }

    // ========================================
    // Conversations Collection
    // ========================================
    match /conversations/{conversationId} {
      // Only participants can read the conversation
      // Using participantIds array for easier querying
      allow read: if isAuthenticated() &&
                    request.auth.uid in resource.data.participantIds;

      // Authenticated users can create conversations
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['participants', 'participantIds', 'status']) &&
                      // User must be one of the participants
                      request.auth.uid in request.resource.data.participantIds &&
                      // Ensure participantIds matches participants array
                      request.resource.data.participantIds.size() == request.resource.data.participants.size();

      // Participants can update conversation metadata (archive, etc.)
      allow update: if isAuthenticated() &&
                      request.auth.uid in resource.data.participantIds &&
                      // Cannot change participants or participantIds
                      request.resource.data.participants == resource.data.participants &&
                      request.resource.data.participantIds == resource.data.participantIds;

      // Participants can delete (archive) conversations
      allow delete: if isAuthenticated() &&
                      request.auth.uid in resource.data.participantIds;
    }

    // ========================================
    // Messages Collection
    // ========================================
    match /messages/{messageId} {
      // Only conversation participants can read messages
      allow read: if isAuthenticated() &&
                    exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
                    request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds;

      // Users can create messages in conversations they're part of
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['conversationId', 'senderId', 'content']) &&
                      request.resource.data.senderId == request.auth.uid &&
                      // Validate message content length (1-5000 characters)
                      request.resource.data.content is string &&
                      request.resource.data.content.size() >= 1 &&
                      request.resource.data.content.size() <= 5000 &&
                      // Basic XSS prevention: Reject messages containing script/iframe tags
                      // Note: Server-side sanitization in MessagingService provides comprehensive XSS protection
                      !request.resource.data.content.matches('.*<script.*') &&
                      !request.resource.data.content.matches('.*<iframe.*') &&
                      exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId));

      // Senders can update their own messages (mark as edited, etc.)
      // Recipients can mark messages as read
      allow update: if isAuthenticated() &&
                      exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
                      (
                        // Sender updating their own message (with content length and XSS validation if content changed)
                        (request.auth.uid == resource.data.senderId &&
                         request.resource.data.senderId == resource.data.senderId &&
                         request.resource.data.conversationId == resource.data.conversationId &&
                         // If content is being updated, validate its length and reject XSS attempts
                         (request.resource.data.content == resource.data.content ||
                          (request.resource.data.content is string &&
                           request.resource.data.content.size() >= 1 &&
                           request.resource.data.content.size() <= 5000 &&
                           !request.resource.data.content.matches('.*<script.*') &&
                           !request.resource.data.content.matches('.*<iframe.*')))) ||
                        // Recipient marking message as read (conversation participant, not the sender)
                        (request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participantIds &&
                         request.auth.uid != resource.data.senderId &&
                         request.resource.data.senderId == resource.data.senderId &&
                         request.resource.data.conversationId == resource.data.conversationId)
                      );

      // Senders can delete their own messages
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == resource.data.senderId || isAdmin());
    }

    // ========================================
    // Payments Collection
    // ========================================
    match /payments/{paymentId} {
      // Employer, worker, and admin can read payment
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.employerId ||
                     request.auth.uid == resource.data.workerId ||
                     isAdmin());

      // Only employers can create payments (initiating escrow)
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['gigId', 'employerId', 'workerId', 'amount']) &&
                      request.resource.data.employerId == request.auth.uid &&
                      request.resource.data.amount > 0 &&
                      request.resource.data.escrowStatus == 'pending' &&
                      exists(/databases/$(database)/documents/gigs/$(request.resource.data.gigId));

      // Employers can update payment status (release escrow)
      // Workers can dispute or release payment
      allow update: if isAuthenticated() &&
                      (
                        // Employer releasing payment
                        (request.auth.uid == resource.data.employerId &&
                         request.resource.data.workerId == resource.data.workerId) ||
                        // Worker disputing or releasing payment
                        (request.auth.uid == resource.data.workerId) ||
                        // Admin managing disputes
                        isAdmin()
                      );

      // Only admin can delete payments
      allow delete: if isAdmin();
    }

    // ========================================
    // Payment Methods Collection
    // ========================================
    match /paymentMethods/{methodId} {
      // Users can only read their own payment methods
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      // Users can create their own payment methods
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['type', 'userId']) &&
                      request.resource.data.userId == request.auth.uid;

      // Users can update their own payment methods
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == resource.data.userId;

      // Users can delete their own payment methods
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ========================================
    // Withdrawals Collection
    // ========================================
    match /withdrawals/{withdrawalId} {
      // Users can read their own withdrawals, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // Users can create withdrawal requests for their own account
      // Rate limiting is enforced at the application level (PaymentService.requestWithdrawal)
      // Rules validate structure and basic constraints
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['userId', 'amount', 'paymentMethodId', 'requestedAt']) &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.amount >= 50 && // Minimum R50
                      request.resource.data.amount <= 50000 && // Maximum R50,000 per withdrawal
                      request.resource.data.status == 'pending' &&
                      request.resource.data.requestedAt is timestamp;

      // Only users can cancel pending withdrawals, admins can update status
      allow update: if isAuthenticated() &&
                      (
                        (request.auth.uid == resource.data.userId &&
                         resource.data.status == 'pending') ||
                        isAdmin()
                      );

      // Users and admins can delete
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ========================================
    // Fee Configuration Collection (Admin Only)
    // ========================================
    match /feeConfigs/{configId} {
      // Anyone can read fee configuration (public information)
      allow read: if true;

      // Only admins can create, update, or delete fee configs
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================
    // Safety Reports Collection (hyphenated path)
    // ========================================
    match /safety-reports/{reportId} {
      // Reporter, reportee (person being reported), and admin can read reports
      // This allows users to see reports about themselves for trust score display
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.reporterId ||
                     request.auth.uid == resource.data.reporteeId ||
                     isAdmin());

      // Authenticated users can create safety reports
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['reporterId', 'reporteeId', 'type', 'description']) &&
                      request.resource.data.reporterId == request.auth.uid &&
                      request.resource.data.status == 'pending';

      // Only admins can update safety reports
      allow update: if isAdmin();

      // Only admins can delete safety reports
      allow delete: if isAdmin();
    }

    // ========================================
    // Safety Reports Collection (camelCase path - legacy support)
    // ========================================
    match /safetyReports/{reportId} {
      // Reporter, reportee (person being reported), and admin can read reports
      // This allows users to see reports about themselves for trust score display
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.reporterId ||
                     request.auth.uid == resource.data.reporteeId ||
                     isAdmin());

      // Authenticated users can create safety reports
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['reporterId', 'reporteeId', 'type', 'description']) &&
                      request.resource.data.reporterId == request.auth.uid &&
                      request.resource.data.status == 'pending';

      // Only admins can update safety reports
      allow update: if isAdmin();

      // Only admins can delete safety reports
      allow delete: if isAdmin();
    }

    // ========================================
    // Safety Check-Ins Collection (camelCase)
    // ========================================
    match /safetyCheckIns/{checkInId} {
      // Users can read their own check-ins, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // Users can create check-ins for gigs they're involved in
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['userId', 'gigId', 'type']) &&
                      request.resource.data.userId == request.auth.uid &&
                      exists(/databases/$(database)/documents/gigs/$(request.resource.data.gigId));

      // Users cannot update check-ins (immutable record)
      allow update: if false;

      // Only admins can delete check-ins
      allow delete: if isAdmin();
    }

    // ========================================
    // Safety Check-Ins Collection (hyphenated - legacy support)
    // ========================================
    match /safety-checkins/{checkInId} {
      // Users can read their own check-ins, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // Users can create check-ins for gigs they're involved in
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['userId', 'gigId', 'type']) &&
                      request.resource.data.userId == request.auth.uid &&
                      exists(/databases/$(database)/documents/gigs/$(request.resource.data.gigId));

      // Users cannot update check-ins (immutable record)
      allow update: if false;

      // Only admins can delete check-ins
      allow delete: if isAdmin();
    }

    // ========================================
    // Background Checks Collection
    // ========================================
    match /backgroundChecks/{checkId} {
      // Users can read their own checks, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // Users can request background checks for themselves
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['userId', 'checkType']) &&
                      request.resource.data.userId == request.auth.uid &&
                      request.resource.data.status == 'pending';

      // Only admins can update background check results
      allow update: if isAdmin();

      // Only admins can delete background checks
      allow delete: if isAdmin();
    }

    // ========================================
    // Trust Score History Collection
    // ========================================
    match /trustScoreHistory/{historyId} {
      // Users can read their own history, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // Users can create trust score history entries for themselves
      // System/admin can create for any user
      allow create: if isAuthenticated() &&
                      (request.resource.data.userId == request.auth.uid || isAdmin());

      // Trust score history is immutable
      allow update: if false;

      // Only admins can delete history
      allow delete: if isAdmin();
    }

    // ========================================
    // Safe Meeting Locations Collection
    // ========================================
    match /safeMeetingLocations/{locationId} {
      // Anyone authenticated can read safe meeting locations
      allow read: if isAuthenticated();

      // Only verified users can suggest locations
      allow create: if isVerifiedUser() &&
                      hasRequiredFields(['name', 'address', 'coordinates', 'type']) &&
                      request.resource.data.verified == false;

      // Only admins can update/verify locations
      allow update: if isAdmin();

      // Only admins can delete locations
      allow delete: if isAdmin();
    }

    // ========================================
    // Milestones Collection (for milestone-based payments)
    // ========================================
    match /milestones/{milestoneId} {
      // Employer, worker, and admin can read milestones
      allow read: if isAuthenticated() &&
                    exists(/databases/$(database)/documents/gigs/$(resource.data.gigId)) &&
                    (request.auth.uid == get(/databases/$(database)/documents/gigs/$(resource.data.gigId)).data.employerId ||
                     request.auth.uid == get(/databases/$(database)/documents/gigs/$(resource.data.gigId)).data.assignedTo ||
                     isAdmin());

      // Only employers can create milestones for their gigs
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['gigId', 'title', 'amount']) &&
                      exists(/databases/$(database)/documents/gigs/$(request.resource.data.gigId)) &&
                      request.auth.uid == get(/databases/$(database)/documents/gigs/$(request.resource.data.gigId)).data.employerId;

      // Employers can update milestone status, workers can mark as completed
      allow update: if isAuthenticated() &&
                      exists(/databases/$(database)/documents/gigs/$(resource.data.gigId)) &&
                      (request.auth.uid == get(/databases/$(database)/documents/gigs/$(resource.data.gigId)).data.employerId ||
                       request.auth.uid == get(/databases/$(database)/documents/gigs/$(resource.data.gigId)).data.assignedTo);

      // Only employers and admins can delete milestones
      allow delete: if isAuthenticated() &&
                      exists(/databases/$(database)/documents/gigs/$(resource.data.gigId)) &&
                      (request.auth.uid == get(/databases/$(database)/documents/gigs/$(resource.data.gigId)).data.employerId ||
                       isAdmin());
    }

    // ========================================
    // Payment Disputes Collection
    // ========================================
    match /paymentDisputes/{disputeId} {
      // Involved parties and admin can read disputes
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.raisedBy ||
                     request.auth.uid == resource.data.raisedAgainst ||
                     isAdmin());

      // Users involved in payment can create disputes
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['paymentId', 'gigId', 'raisedBy', 'reason']) &&
                      request.resource.data.raisedBy == request.auth.uid &&
                      exists(/databases/$(database)/documents/payments/$(request.resource.data.paymentId));

      // Involved parties can add evidence, admins can resolve
      allow update: if isAuthenticated() &&
                      (
                        // Parties adding evidence to open disputes
                        ((request.auth.uid == resource.data.raisedBy ||
                          request.auth.uid == resource.data.raisedAgainst) &&
                         resource.data.status in ['open', 'investigating']) ||
                        // Admin resolving disputes
                        isAdmin()
                      );

      // Only admins can delete disputes
      allow delete: if isAdmin();
    }

    // ========================================
    // Location Safety Ratings Collection (camelCase)
    // ========================================
    match /locationSafetyRatings/{ratingId} {
      // Anyone authenticated can read location safety ratings
      allow read: if isAuthenticated();

      // Only system/admin can create or update ratings (aggregated data)
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================
    // Location Safety Ratings Collection (hyphenated - legacy support)
    // ========================================
    match /location-safety-ratings/{ratingId} {
      // Anyone authenticated can read location safety ratings
      allow read: if isAuthenticated();

      // Only system/admin can create or update ratings (aggregated data)
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ========================================
    // Payment History Collection
    // ========================================
    match /paymentHistory/{historyId} {
      // Users can read their own payment history
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      // System can create payment history entries (via Cloud Functions or backend)
      // For client-side, only allow if authenticated and creating for self
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['userId', 'type', 'amount', 'status']) &&
                      request.resource.data.userId == request.auth.uid;

      // Payment history is generally immutable, but allow updates for status changes
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;

      // Users can delete their own history, admins can delete any
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == resource.data.userId || isAdmin());
    }

    // ========================================
    // Payment Intents Collection (camelCase)
    // ========================================
    match /paymentIntents/{intentId} {
      // Users can read their own payment intents
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.employerId ||
                     request.auth.uid == resource.data.workerId);

      // Users can create payment intents
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['gigId', 'employerId', 'workerId', 'amount']) &&
                      request.resource.data.employerId == request.auth.uid;

      // System/admin can update payment intent status
      allow update: if isAuthenticated() &&
                      (request.auth.uid == resource.data.employerId || isAdmin());

      // Only admins can delete payment intents
      allow delete: if isAdmin();
    }

    // ========================================
    // Payment Intents Collection (snake_case - for PayFast integration)
    // ========================================
    match /payment_intents/{intentId} {
      // Users can read their own payment intents
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId);

      // Users can create payment intents (client-side for payment gateway)
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['gigId', 'userId', 'amount']) &&
                      request.resource.data.userId == request.auth.uid;

      // System/admin can update payment intent status
      allow update: if isAuthenticated() &&
                      (request.auth.uid == resource.data.userId || isAdmin());

      // Only admins can delete payment intents
      allow delete: if isAdmin();
    }

    // ========================================
    // Wallet Transactions Collection
    // ========================================
    match /wallet_transactions/{transactionId} {
      // Users can read their own wallet transactions
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      // Users can create wallet transactions (deposits, etc.)
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['userId', 'type', 'amount', 'status']) &&
                      request.resource.data.userId == request.auth.uid;

      // System/admin can update transaction status
      allow update: if isAuthenticated() &&
                      (request.auth.uid == resource.data.userId || isAdmin());

      // Only admins can delete transactions
      allow delete: if isAdmin();
    }

    // ========================================
    // Escrow Collection
    // ========================================
    match /escrow/{escrowId} {
      // Employer, worker, and admin can read escrow
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.employerId ||
                     request.auth.uid == resource.data.workerId ||
                     isAdmin());

      // Users can create escrow (when funding gigs)
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['gigId', 'employerId', 'totalAmount']) &&
                      request.resource.data.employerId == request.auth.uid;

      // Employer can release escrow, admin can manage
      allow update: if isAuthenticated() &&
                      (request.auth.uid == resource.data.employerId || isAdmin());

      // Only admins can delete escrow
      allow delete: if isAdmin();
    }

    // ========================================
    // Escrow Accounts Collection
    // ========================================
    match /escrowAccounts/{escrowId} {
      // Employer, worker, and admin can read escrow accounts
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.employerId ||
                     request.auth.uid == resource.data.workerId ||
                     isAdmin());

      // System/admin can create escrow accounts
      allow create: if isAuthenticated() &&
                      hasRequiredFields(['paymentId', 'gigId', 'employerId', 'workerId', 'totalAmount']);

      // Employer can release escrow, admin can manage
      allow update: if isAuthenticated() &&
                      (request.auth.uid == resource.data.employerId || isAdmin());

      // Only admins can delete escrow accounts
      allow delete: if isAdmin();
    }

    // ========================================
    // Admin Collection (for admin user management)
    // ========================================
    match /admins/{adminId} {
      // Only admins can read admin list
      allow read: if isAdmin();

      // Only existing admins can add new admins
      allow create: if isAdmin();

      // Admins cannot update themselves
      allow update: if isAdmin() && request.auth.uid != adminId;

      // Only super admin can delete (implement custom logic)
      allow delete: if isAdmin();
    }

    // ========================================
    // Verification Results Collection (camelCase)
    // ========================================
    match /verificationResults/{resultId} {
      // Users can read their own verification results, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // System/admin can create verification results
      allow create: if isAdmin();

      // System/admin can update verification results
      allow update: if isAdmin();

      // Only admins can delete verification results
      allow delete: if isAdmin();
    }

    // ========================================
    // Verification Results Collection (hyphenated - legacy support)
    // ========================================
    match /verification-results/{resultId} {
      // Users can read their own verification results, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // System/admin can create verification results
      allow create: if isAdmin();

      // System/admin can update verification results
      allow update: if isAdmin();

      // Only admins can delete verification results
      allow delete: if isAdmin();
    }

    // ========================================
    // Verification Documents Collection
    // ========================================
    match /verificationDocuments/{documentId} {
      // Individual document reads - users can read their own, admins can read all
      allow get: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // Collection queries - users can list their own documents (filtered by userId in query)
      // Admins can list all documents
      allow list: if isAuthenticated();

      // Users can create their own verification documents
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Users can update their own verification documents, admins can update all
      allow update: if isAuthenticated() &&
                      (request.resource.data.userId == request.auth.uid || isAdmin());

      // Users can delete their own verification documents, admins can delete all
      allow delete: if isAuthenticated() &&
                      (request.resource.data.userId == request.auth.uid || isAdmin());
    }

    // ========================================
    // Emergency Contacts Collection
    // ========================================
    match /emergencyContacts/{contactId} {
      // Users can read their own emergency contacts, admins can read all
      allow read: if isAuthenticated() &&
                    (request.auth.uid == resource.data.userId || isAdmin());

      // Users can create their own emergency contacts
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Users can update their own emergency contacts
      allow update: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Users can delete their own emergency contacts
      allow delete: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;
    }
    // ========================================
    // Platform Configuration Collection (Admin Only)
    // ========================================
    match /platformConfig/{configId} {
      // Anyone can read platform configuration (needed for app functionality)
      allow read: if true;

      // Only admins can create or update platform config
      allow create: if isAdmin();
      allow update: if isAdmin();

      // Only admins can delete platform config
      allow delete: if isAdmin();
    }

    // ========================================
    // Config Audit Log (Admin Only)
    // ========================================
    match /configAuditLog/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();

      // Only admins can create audit log entries (via ConfigService)
      allow create: if isAdmin();

      // No updates or deletes - audit logs are immutable
      allow update, delete: if false;
    }

    // ========================================
    // Default Deny All Other Collections
    // Security by default: deny all access to undefined collections
    // ========================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
